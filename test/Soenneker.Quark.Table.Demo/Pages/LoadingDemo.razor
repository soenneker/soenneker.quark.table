@page "/loading"
@using Microsoft.Extensions.Logging
@using Soenneker.DataTables.Dtos.ServerResponse
@using Soenneker.DataTables.Dtos.ServerSideRequest
@using Soenneker.Quark.Table.Demo.Services

@inject ILogger<LoadingDemo> Logger
@inject EmployeeService EmployeeService

<PageTitle>Loading Demo - QuarkTable</PageTitle>

<div class="container-fluid" >
    <div class="row" >
        <div class="col-12" >
            <nav aria-label="breadcrumb" >
                <ol class="breadcrumb" >
                    <li class="breadcrumb-item" >
                        <a href="/" >Home</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page" >Loading Demo</li>
                </ol>
            </nav>

            <h1 class="display-4 mb-4" >Loading Demo</h1>
            <p class="lead mb-4" >Demonstrating loading indicators and delayed server-side processing in QuarkTable.</p>
        </div>
    </div>

    <!-- Default Loading Indicator -->
    <div class="row mb-5" >
        <div class="col-12" >
            <div class="card" >
                <div class="card-header" >
                    <h3><i class="fas fa-spinner fa-spin text-primary" ></i> Default Loading Indicator</h3>
                    <p class="text-muted mb-0" >Uses the built-in loading indicator with simulated network delay</p>
                </div>
                <div class="card-body" >
                    <QuarkTable @ref="defaultLoadingTable"
                                OnServerSideRequest="HandleServerSideRequestWithDelay"
                                OnSearch="HandleSearch"
                                OnOrder="HandleOrder"
                                ShowSearch="true"
                                SearchPlaceholder="Search employees..."
                                Options="defaultLoadingOptions" >
                    </QuarkTable>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Loading Indicator -->
    <div class="row mb-5" >
        <div class="col-12" >
            <div class="card" >
                <div class="card-header" >
                    <h3><i class="fas fa-cog fa-spin text-success" ></i> Custom Loading Indicator</h3>
                    <p class="text-muted mb-0" >Custom loading indicator with enhanced styling</p>
                </div>
                <div class="card-body" >
                    <QuarkTable @ref="customLoadingTable"
                                OnServerSideRequest="HandleServerSideRequestWithDelay"
                                OnSearch="HandleSearch"
                                OnOrder="HandleOrder"
                                ShowSearch="true"
                                SearchPlaceholder="Search employees..."
                                Options="customLoadingOptions" >
                        <ManualHeader>
                            <thead>
                                <tr>
                                    <th data-priority="1">Name</th>
                                    <th>Department</th>
                                    <th>Email</th>
                                    <th>Salary</th>
                                    <th>Hire Date</th>
                                    <th>Id</th>
                                </tr>
                            </thead>
                        </ManualHeader>
                        <LoadingIndicator>
                            <div class="custom-loading-overlay" >
                                <div class="custom-loading-content" >
                                    <div class="spinner-border text-primary" role="status" >
                                        <span class="visually-hidden" >Loading...</span>
                                    </div>
                                    <div class="mt-3" >
                                        <h6 class="text-primary" >Loading Data...</h6>
                                        <p class="text-muted small" >Please wait while we fetch your data</p>
                                    </div>
                                </div>
                            </div>
                        </LoadingIndicator>
                    </QuarkTable>
                </div>
            </div>
        </div>
    </div>

    <!-- No Loading Indicator -->
    <div class="row mb-5" >
        <div class="col-12" >
            <div class="card" >
                <div class="card-header" >
                    <h3><i class="fas fa-eye-slash text-warning" ></i> No Loading Indicator</h3>
                    <p class="text-muted mb-0" >Table without loading indicator (may appear unresponsive during delays)</p>
                </div>
                <div class="card-body" >
                    <QuarkTable @ref="noLoadingTable"
                                OnServerSideRequest="HandleServerSideRequestWithDelay"
                                OnSearch="HandleSearch"
                                OnOrder="HandleOrder"
                                ShowSearch="true"
                                SearchPlaceholder="Search employees..."
                                Options="noLoadingOptions" >
                    </QuarkTable>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Configuration -->
    <div class="row" >
        <div class="col-12" >
            <div class="card" >
                <div class="card-header" >
                    <h3>Loading Configuration Options</h3>
                </div>
                <div class="card-body" >
                    <div class="row" >
                        <div class="col-md-6" >
                            <h5>Loading Indicator Types</h5>
                            <ul class="list-unstyled" >
                                <li><i class="fas fa-check text-success" ></i> <strong>Default:</strong> Built-in spinner with overlay</li>
                                <li><i class="fas fa-check text-success" ></i> <strong>Custom:</strong> User-defined loading content</li>
                                <li><i class="fas fa-check text-success" ></i> <strong>None:</strong> No loading indicator</li>
                            </ul>
                        </div>
                        <div class="col-md-6" >
                            <h5>Best Practices</h5>
                            <ul class="list-unstyled" >
                                <li><i class="fas fa-info-circle text-info" ></i> Always show loading for server-side requests</li>
                                <li><i class="fas fa-info-circle text-info" ></i> Use custom indicators for branded experiences</li>
                                <li><i class="fas fa-info-circle text-info" ></i> Consider user feedback during delays</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Loading Indicator Template -->
@if (customLoadingIndicator != null)
{
    <div id="custom-loading-indicator" style="display:none" >
        <div class="custom-loading-overlay" >
            <div class="custom-loading-content" >
                <div class="spinner-border text-primary" role="status" >
                    <span class="visually-hidden" >Loading...</span>
                </div>
                <div class="mt-3" >
                    <h6 class="text-primary" >Loading Data...</h6>
                    <p class="text-muted small" >Please wait while we fetch your data</p>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private QuarkTable? defaultLoadingTable;
    private QuarkTable? customLoadingTable;
    private QuarkTable? noLoadingTable;
    private RenderFragment? customLoadingIndicator;


    private QuarkTableOptions defaultLoadingOptions = new()
    {
        DefaultPageSize = 8,
        ShowSearch = true,
        ShowPagination = true,
        ShowPageSizeSelector = true,
        Sortable = true,
        ServerSide = true
    };

    private QuarkTableOptions customLoadingOptions = new()
    {
        DefaultPageSize = 8,
        ShowSearch = true,
        ShowPagination = true,
        ShowPageSizeSelector = true,
        Sortable = true,
        ServerSide = true
    };

    private QuarkTableOptions noLoadingOptions = new()
    {
        DefaultPageSize = 8,
        ShowSearch = true,
        ShowPagination = true,
        ShowPageSizeSelector = true,
        Sortable = true,
        ServerSide = true
    };

    protected override async Task OnInitializedAsync()
    {
        // EmployeeService is automatically initialized
    }

    private async Task<DataTableServerResponse> HandleServerSideRequestWithDelay(DataTableServerSideRequest serverSideRequest)
    {
        Logger.LogInformation("Delayed server-side request: Start={Start}, Length={Length}, Search='{Search}'", serverSideRequest.Start, serverSideRequest.Length, serverSideRequest.Search?.Value);

        // Simulate network delay (1-3 seconds)
        int delayMs = Random.Shared.Next(1000, 3000);
        await Task.Delay(delayMs);

        return await EmployeeService.GetEmployees(serverSideRequest);
    }

    private async Task HandleSearch(string searchTerm)
    {
        Logger.LogInformation("Search performed: {SearchTerm}", searchTerm);
    }

    private async Task HandleOrder(QuarkTableOrderEventArgs args)
    {
        Logger.LogInformation("Column '{Column}' sorted {Direction}", args.Column, args.Direction);
    }


}