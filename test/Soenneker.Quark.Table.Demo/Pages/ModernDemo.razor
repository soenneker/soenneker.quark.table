@page "/modern-demo"
@using Microsoft.Extensions.Logging
@using Soenneker.Quark.Table.Enums
@using Soenneker.Quark.Table.Demo.Services
@using Soenneker.Quark.Table.Demo.Dtos
@using Soenneker.Extensions.Task

@inject ILogger<ModernDemo> Logger
@inject EmployeeService EmployeeService

<PageTitle>Modern Demo - QuarkTable</PageTitle>

<style>
    :root {
        /* Core tones */
        --qt-bg: #ffffff;
        --qt-surface: #ffffff;
        --qt-surface-2: #ffffff;
        --qt-border: #dee2e6;
        --qt-row-alt: #ffffff;
        --qt-hover: #eef3f7;
        /* Content colours */
        --qt-text: #212529;
        --qt-muted: #6c757d;
        --qt-heading: #000000;
        /* Accent / states */
        --qt-accent: #6c757d;
        --qt-accent-hover: #5c636a;
        --qt-focus-ring: rgba(108, 117, 125, 0.25);
        /* Shared colors for light bg components */
        --qt-shadow: rgba(0, 0, 0, 0.08);
        --qt-hover-alt: #eef1f4;
        --qt-border-light: rgba(0, 0, 0, 0.04);
    }

    /* Box styling */
    .quark-table {
        border: none !important;
        box-shadow: none; /* override any previous shadow */
    }

        /* Optional: soften box-shadow on light background */
        .quark-table.with-shadow {
            box-shadow: 0 2px 4px var(--qt-shadow);
        }

    /* Optional: lighter pagination buttons on hover */
    .quark-table-pagination-btn:hover:not([disabled]) {
        background-color: var(--qt-hover);
        border-color: var(--qt-accent);
    }

    /* Optional: active pagination button tint */
    .quark-table-pagination-btn.active {
        color: #fff;
    }

    .quark-table-search-input {
        background: #f0f2f5;
        border-radius: 0.375rem;
    }

    .quark-table-sortable {
        background-color: rgb(229, 231, 235) !important;
        color: rgb(17, 24, 39) !important;
    }

    /* Hover states */
    .quark-table tbody tr:hover,
    .quark-table-pagination-btn:hover:not([disabled]) {
        background-color: var(--qt-hover-alt);
    }

    /* Table cell spacing */
    .quark-table th,
    .quark-table td {
        padding: 0.3rem 0.6rem;
        line-height: 1.2;
        border-bottom: 1px solid var(--qt-border-light);
    }

    .quark-table-search-cell {
        padding: 0.4rem 0.6rem;
    }

    /* Edge case: last row cleanup */
    .quark-table tbody tr:last-child td {
        border-bottom-color: var(--qt-border-light);
    }

    /* Header / control bar */
    .quark-table-with-search .quark-table-search,
    .quark-table-controls {
        border: none;
    }
</style>

<QuarkTable @ref="_modernTable"
            OnInteraction="HandleManualRequest"
            OnOrder="HandleOrder"
            OnInitialize="HandleInitialize"
            Options="_modernTableOptions"
            TotalRecords="@_totalRecords" >

    <QuarkTableSearch Placeholder="Search..." />

    <QuarkTableElement>
        <QuarkThead>
            <QuarkTr>
                <QuarkTh Data="Name" Sortable="true" Searchable="true" >Name</QuarkTh>
                <QuarkTh Data="Department" Sortable="true" Searchable="true" >Department</QuarkTh>
                <QuarkTh Data="Email" Sortable="true" Searchable="true" >Email</QuarkTh>
                <QuarkTh Data="Salary" Sortable="true" Searchable="true" >Salary</QuarkTh>
                <QuarkTh Data="HireDate" Sortable="true" Searchable="true" >Hire Date</QuarkTh>
                <QuarkTh Data="Status" Sortable="true" Searchable="true" >Status</QuarkTh>
            </QuarkTr>
        </QuarkThead>

        <QuarkTbody>
            @if (_currentEmployees is {Count: > 0})
            {
                @foreach (var employee in _currentEmployees)
                {
                    <QuarkTr Key="@employee.Id" >
                        <QuarkTd>@employee.Name</QuarkTd>
                        <QuarkTd>@employee.Department</QuarkTd>
                        <QuarkTd>@employee.Email</QuarkTd>
                        <QuarkTd>@employee.Salary.ToString("C")</QuarkTd>
                        <QuarkTd>@employee.HireDate.ToString("MMM dd, yyyy")</QuarkTd>
                        <QuarkTd>@employee.Status</QuarkTd>
                    </QuarkTr>
                }
            }
            else if (_hasLoadedOnce)
            {
                <QuarkTableNoData>
                    <div class="no-data" >
                        <h4>No employees found</h4>
                        <p>Try adjusting your search criteria.</p>
                    </div>
                </QuarkTableNoData>
            }
        </QuarkTbody>
    </QuarkTableElement>

    <QuarkTableControls>
        <QuarkTablePagination />
    </QuarkTableControls>
</QuarkTable>

@code {
    private QuarkTable? _modernTable;
    private List<Employee> _currentEmployees = new();
    private bool _hasLoadedOnce = false;

    private readonly QuarkTableOptions _modernTableOptions = new()
    {
        DefaultPageSize = 10,
        SearchPosition = SearchPosition.End
    };

    private int _totalRecords;

    protected override async Task OnInitializedAsync()
    {
        // Initialize with employee data
        _totalRecords = EmployeeService.GetTotalCount();
        Logger.LogInformation("ModernDemo: OnInitializedAsync - Initialized with {TotalRecords} total employee records", _totalRecords);
    }

    private async Task HandleManualRequest(DataTableServerSideRequest serverSideRequest)
    {
        Logger.LogInformation("ModernDemo: HandleManualRequest called: Request: Start={Start}, Length={Length}", serverSideRequest.Start, serverSideRequest.Length);

        try
        {
            // Get filtered employees using the EmployeeService
            List<Employee> employees = await EmployeeService.GetFilteredEmployees(serverSideRequest).NoSync();

            Logger.LogInformation("ModernDemo: Returned {Count} employees", employees.Count);

            // Update the current employees list
            _currentEmployees = employees;
            _hasLoadedOnce = true;

            // Update the total records count
            _totalRecords = EmployeeService.GetTotalCount();

            // Trigger UI update
            StateHasChanged();

            Logger.LogInformation("ModernDemo: Updated currentEmployees with {Count} records, totalRecords={TotalRecords}", _currentEmployees.Count, _totalRecords);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ModernDemo: Error handling manual request: {Message}", ex.Message);
        }
    }

    private async Task HandleOrder(QuarkTableOrderEventArgs args)
    {
        Logger.LogInformation("Column '{Column}' sorted {Direction}", args.Column, args.Direction);
    }

    private async Task HandleInitialize()
    {
        Logger.LogInformation("Modern table initialized");
    }
}