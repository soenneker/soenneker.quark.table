@using System.Threading
@using Microsoft.Extensions.Logging
@using Soenneker.Extensions.Task
@using Soenneker.Quark.Table.Options
@using Soenneker.Quark.Table.Dtos
@using Soenneker.Quark.Table.Abstract
@using Soenneker.Quark.Table.Enums
@using Soenneker.Utils.Debounce

@inherits ComponentBase
@implements IQuarkTable

<div class="quark-table-wrapper" style="@(Visible ? string.Empty : "visibility:hidden;position:absolute;left:-9999px")" >

    <div class="quark-table-controls @GetSearchPositionClass()" >
        @if (Options.ShowPageSizeSelector)
        {
            <div class="quark-table-page-size" >
                <label>Show:</label>
                <select value="@_pageSize" @onchange="OnPageSizeChangedHandler">
                    @for (var i = 0; i < Options.PageSizeOptions.Length; i++)
                    {
                        int size = Options.PageSizeOptions[i];
                        <option value="@size" selected="@(size == _pageSize)">@size</option>
                    }
                </select>
                <span>entries per page</span>
            </div>
        }

        @if (Options.ShowSearch)
        {
            <div class="quark-table-search" >
                <label>Search:</label>
                <input type="text"
                       value="@SearchTerm"
                       @oninput="OnSearchInputHandler"
                       placeholder="@Options.SearchPlaceholder"
                       class="quark-table-search-input" />
            </div>
        }
    </div>

    <div class="quark-table-container" >
        @if (_columns.Count == 0 && !_isLoading && !ManualMode)
        {
            <div class="text-center p-4" >
                <p>Loading table...</p>
            </div>
        }
        else
        {
            <table id="@ElementId" class="quark-table" >
                @if (ManualMode && ManualHeader != null)
                {
                    @ManualHeader
                }
                else if (_columns.Count > 0)
                {
                    <thead>
                        <tr>
                            @for (var c = 0; c < _columns.Count; c++)
                            {
                                string col = _columns[c];
                                <th @onclick="() => HandleColumnSort(col)"
                                    class="quark-table-sortable @(GetSortClass(col))"
                                    style="cursor:pointer;" >
                                    @col @GetSortIndicator(col)
                                </th>
                            }
                        </tr>
                    </thead>
                }
                else if (_isLoading)
                {
                    <thead>
                        <tr>
                            <th style="width: 100%;">
                                @if (LoadingIndicator != null)
                                {
                                    @LoadingIndicator
                                }
                                else
                                {
                                    <div class="text-center p-2">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="ms-2">Loading...</span>
                                    </div>
                                }
                            </th>
                        </tr>
                    </thead>
                }
                <tbody style="position:relative;" >
                    @if (_isLoading)
                    {
                        <tr>
                            <td colspan="@(_columns.Count > 0 ? _columns.Count : 1)" style="padding:0;border:none;" >
                                <div class="quark-table-loading-indicator" style="display:flex;" >
                                    @if (LoadingIndicator != null)
                                    {
                                        @LoadingIndicator
                                    }
                                    else
                                    {
                                        <div class="text-center p-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="mt-2">Loading...</div>
                                        </div>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                    @if (ManualMode && ManualBody != null)
                    {
                        @ManualBody
                    }
                    else
                    {
                        @for (var r = 0; r < _rows.Count; r++)
                        {
                            List<string> row = _rows[r];
                            <tr @key="r" >
                                @for (var j = 0; j < row.Count; j++)
                                {
                                    <td>@row[j]</td>
                                }
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
    </div>

    @if (Options.ShowPagination && _totalPages > 1)
    {
        <div class="quark-table-pagination" >
            @if (Options.ShowInfo)
            {
                <div class="quark-table-info" >Showing @StartRecord to @EndRecord of @_totalRecords entries</div>
            }
            <div class="quark-table-pagination-controls" >
                <button class="quark-table-pagination-btn" @onclick="HandleFirstPage" disabled="@(_currentPage == 1)" title="First" >Â«</button>
                <button class="quark-table-pagination-btn" @onclick="HandlePreviousPage" disabled="@(_currentPage == 1)" title="Previous" >â€¹</button>

                @{
                    Logger.LogDebug("Rendering pagination buttons: StartPage={StartPage}, EndPage={EndPage}, CurrentPage={CurrentPage}, TotalPages={TotalPages}", StartPage, EndPage, _currentPage, _totalPages);
                }
                @for (int p = StartPage; p <= EndPage; p++)
                {
                    var pageNumber = p;          // ðŸ‘ˆ capture by value
                    <button class="quark-table-pagination-btn @(pageNumber == _currentPage ? "active" : string.Empty)"
                            @onclick="@(() => HandleGoToPage(pageNumber))">
                        @pageNumber
                    </button>
                }

                <button class="quark-table-pagination-btn" @onclick="HandleNextPage" disabled="@(_currentPage == _totalPages)" title="Next" >â€º</button>
                <button class="quark-table-pagination-btn" @onclick="HandleLastPage" disabled="@(_currentPage == _totalPages)" title="Last" >Â»</button>
            </div>
        </div>
    }
</div>

@code {

    [Inject]
    private IQuarkTableInterop QuarkTableInterop { get; set; } = null!;

    [Inject]
    private ILogger<QuarkTable> Logger { get; set; } = null!;

    [Parameter]
    public EventCallback OnInitialize { get; set; }

    [Parameter]
    public EventCallback<string> OnSearch { get; set; }

    [Parameter]
    public EventCallback<int> OnPageSizeChanged { get; set; }

    [Parameter]
    public EventCallback<int> OnGoToPage { get; set; }

    [Parameter]
    public EventCallback<QuarkTableOrderEventArgs> OnOrder { get; set; }

    [Parameter]
    public Func<QuarkTableRequest, Task<QuarkTableResponse>>? OnServerSideRequest { get; set; }

    [Parameter]
    public QuarkTableOptions Options { get; set; } = new();

    [Parameter]
    public RenderFragment? LoadingIndicator { get; set; }

    [Parameter]
    public bool Visible { get; set; } = true;

    [Parameter]
    public bool ShowSearch { get; set; } = true;

    [Parameter]
    public bool ShowPagination { get; set; } = true;

    [Parameter]
    public bool ShowPageSizeSelector { get; set; } = true;

    [Parameter]
    public int[] PageSizeOptions { get; set; } = [10, 25, 50, 100];

    [Parameter]
    public string SearchPlaceholder { get; set; } = "Search...";

    [Parameter]
    public int SearchDebounceMs { get; set; } = 300;

    [Parameter]
    public int MaxPageButtons { get; set; } = 5;

    [Parameter]
    public bool ManualMode { get; set; }

    [Parameter]
    public RenderFragment? ManualHeader { get; set; }

    [Parameter]
    public RenderFragment? ManualBody { get; set; }

    [Parameter]
    public object? DirectData { get; set; }

    [Parameter]
    public int TotalRecords { get; set; }

    [Parameter]
    public EventCallback<QuarkTableRequest> OnManualRequest { get; set; }

    public readonly string ElementId = $"quark-table-{Guid.NewGuid():N}";

    // Debug properties
    public int CurrentPage => _currentPage;
    public int PageSize => _pageSize;
    public int TotalPages => _totalPages;

    private readonly Debouncer _debouncer = new();
    private readonly List<string> _columns = [];
    private readonly List<QuarkTableOrder> _currentOrders = [];
    private readonly List<List<string>> _rows = [];

    private string _searchTerm = string.Empty;
    private string? _continuationToken;

    private int _currentPage = 1;
    private int _pageSize;
    private int _totalRecords;
    private int _totalPages;

    private bool _dataChanged;
    private bool _isLoading;
    private bool _initialized;
    private QuarkTableOptions? _previousOptions;

    public string SearchTerm => _searchTerm;

    private int StartRecord => (_currentPage - 1) * _pageSize + 1;
    private int EndRecord => Math.Min(_currentPage * _pageSize, _totalRecords);
    public int StartPage
    {
        get
        {
            // Ensure we have valid values
            if (_totalPages <= 0) return 1;
            if (_currentPage <= 0) return 1;
            
            // Simple pagination: show a window around the current page
            int halfButtons = Options.MaxPageButtons / 2;
            int start = _currentPage - halfButtons;
            
            // Ensure we don't go below page 1
            start = Math.Max(1, start);
            
            // If we're near the end, adjust to show the last MaxPageButtons pages
            if (start + Options.MaxPageButtons - 1 > _totalPages)
            {
                start = Math.Max(1, _totalPages - Options.MaxPageButtons + 1);
            }
            
            // Ensure we don't exceed total pages
            if (start > _totalPages) start = _totalPages;
            
            return start;
        }
    }
    
    public int EndPage => Math.Min(_totalPages, StartPage + Options.MaxPageButtons - 1);

    protected override async Task OnInitializedAsync()
    {
        _pageSize = Options.DefaultPageSize;
        await QuarkTableInterop.Initialize();

        if (ManualMode)
        {
            _totalRecords = TotalRecords;
            _totalPages = (int) Math.Ceiling((double) _totalRecords / _pageSize);
            // Load initial data for manual mode
            if (OnManualRequest.HasDelegate)
            {
                await HandleManualRequest();
            }
        }
        else if (OnServerSideRequest != null)
        {
            await LoadData();
        }
        else if (DirectData != null)
        {
            UpdateTableData(DirectData);
            _totalRecords = _rows.Count;
            _totalPages = (int) Math.Ceiling((double) _totalRecords / _pageSize);
        }

        _initialized = true;
        if (OnInitialize.HasDelegate)
            await OnInitialize.InvokeAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Check if options have changed and trigger reload if needed
        if (_initialized && _previousOptions != null && !Options.Equals(_previousOptions))
        {
            _pageSize = Options.DefaultPageSize;
            _currentPage = 1;
            // Clear continuation token when options change
            _continuationToken = null;
            if (ManualMode)
            {
                if (OnManualRequest.HasDelegate)
                {
                    await HandleManualRequest();
                }
            }
            else if (OnServerSideRequest != null)
            {
                await LoadData();
            }
        }
        
        if (DirectData != null && !ManualMode)
        {
            UpdateTableData(DirectData);
            _totalRecords = _rows.Count;
            _totalPages = (int) Math.Ceiling((double) _totalRecords / _pageSize);
            _dataChanged = true;
        }
        
        _previousOptions = Options.Clone();
        await base.OnParametersSetAsync();
    }

    private Task OnSearchInputHandler(ChangeEventArgs e)
    {
        _searchTerm = e.Value?.ToString() ?? string.Empty;

        _debouncer.Debounce(Options.SearchDebounceMs, async ct =>
        {
            _currentPage = 1;
            // Clear continuation token when searching
            _continuationToken = null;
            if (ManualMode)
            {
                await HandleManualRequest(ct);
            }
            else
            {
                await LoadData(ct).NoSync();
            }

            if (OnSearch.HasDelegate)
                await OnSearch.InvokeAsync(_searchTerm);
        });

        return Task.CompletedTask;
    }

    private async Task OnPageSizeChangedHandler(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int size) && size != _pageSize)
        {
            _pageSize = size;
            _currentPage = 1;
            // Clear continuation token when changing page size
            _continuationToken = null;
            if (ManualMode)
            {
                await HandleManualRequest();
            }
            else
            {
                await LoadData();
            }
            if (OnPageSizeChanged.HasDelegate) await OnPageSizeChanged.InvokeAsync(_pageSize);
        }
    }

    private async Task HandleFirstPage()
    {
        if (_currentPage == 1) return;
        _currentPage = 1;
        // Clear continuation token when going to first page
        _continuationToken = null;
        if (ManualMode)
        {
            await HandleManualRequest();
        }
        else
        {
            await LoadData();
        }
    }

    private async Task HandlePreviousPage()
    {
        if (_currentPage == 1) return;
        _currentPage--;
        // Clear continuation token when navigating backwards
        _continuationToken = null;
        if (ManualMode)
        {
            await HandleManualRequest();
        }
        else
        {
            await LoadData();
        }
    }

    private async Task HandleNextPage()
    {
        if (_currentPage == _totalPages) return;
        _currentPage++;
        if (ManualMode)
        {
            await HandleManualRequest();
        }
        else
        {
            await LoadData();
        }
    }

    private async Task HandleLastPage()
    {
        if (_currentPage == _totalPages) return;
        _currentPage = _totalPages;
        if (ManualMode)
        {
            await HandleManualRequest();
        }
        else
        {
            await LoadData();
        }
    }

    public async Task HandleGoToPage(int page)
    {
        Logger.LogDebug("HandleGoToPage called: requested page={Page}, current page={CurrentPage}, total pages={TotalPages}, StartPage={StartPage}, EndPage={EndPage}", 
            page, _currentPage, _totalPages, StartPage, EndPage);
            
        // Validate the page number
        if (page < 1)
        {
            Logger.LogWarning("HandleGoToPage: Invalid page number {Page} - must be >= 1", page);
            return;
        }
        
        if (page > _totalPages)
        {
            Logger.LogWarning("HandleGoToPage: Invalid page number {Page} - must be <= {TotalPages}", page, _totalPages);
            return;
        }
        
        if (page == _currentPage)
        {
            Logger.LogDebug("HandleGoToPage: Already on page {Page}, no action needed", page);
            return;
        }
        
        Logger.LogDebug("HandleGoToPage: setting current page from {OldPage} to {NewPage}", _currentPage, page);
        _currentPage = page;
        // Clear continuation token when navigating to a specific page
        _continuationToken = null;
        
        Logger.LogDebug("HandleGoToPage: set current page to {Page}, cleared continuation token. After setting: _currentPage={CurrentPage}, StartPage={StartPage}, EndPage={EndPage}", 
            _currentPage, _currentPage, StartPage, EndPage);
        
        if (ManualMode)
        {
            await HandleManualRequest();
        }
        else
        {
            await LoadData();
        }
        if (OnGoToPage.HasDelegate) await OnGoToPage.InvokeAsync(page);
    }

    private async Task HandleColumnSort(string col)
    {
        if (!Options.Sortable) return;
        
        Logger.LogDebug("Sorting column: {Column}", col);
        
        QuarkTableOrder? existing = _currentOrders.FirstOrDefault(o => o.Column == col);
        string? next = existing?.Direction == "asc" ? "desc" : existing?.Direction == "desc" ? null : "asc";
        
        _currentOrders.RemoveAll(o => o.Column == col);
        if (next != null) 
        {
            _currentOrders.Add(new QuarkTableOrder {Column = col, Direction = next});
        }
        
        _currentPage = 1;
        // Clear continuation token when sorting
        _continuationToken = null;
        if (ManualMode)
        {
            await HandleManualRequest();
        }
        else
        {
            await LoadData();
        }
        
        if (OnOrder.HasDelegate)
        {
            var args = new QuarkTableOrderEventArgs 
            {
                Column = col, 
                Direction = next ?? string.Empty, 
                Orders = _currentOrders.ToList()
            };
            await OnOrder.InvokeAsync(args);
        }
    }

    /*************** Data ***************/
    private async Task LoadData(CancellationToken cancellationToken = default)
    {
        if (OnServerSideRequest == null) return;
        
        _isLoading = true;
        _dataChanged = true;
        await InvokeAsync(StateHasChanged).NoSync();
        
        try
        {
            var request = new QuarkTableRequest
            {
                Start = (_currentPage - 1) * _pageSize,
                Length = _pageSize,
                Search = new QuarkTableSearch {Value = _searchTerm},
                Order = _currentOrders,
                ContinuationToken = _continuationToken
            };
            

            
            Logger.LogDebug("LoadData: _currentPage={CurrentPage}, _pageSize={PageSize}, calculated Start={Start}, Length={Length}, TotalPages={TotalPages}", 
                _currentPage, _pageSize, request.Start, request.Length, _totalPages);
                
            QuarkTableResponse resp = await OnServerSideRequest.Invoke(request);
            _totalRecords = resp.TotalRecords;
            _totalPages = (int) Math.Ceiling((double) _totalRecords / _pageSize);
            Logger.LogDebug("Calculated total pages: {TotalRecords} / {PageSize} = {TotalPages}", 
                _totalRecords, _pageSize, _totalPages);
            // Only set continuation token if the server supports it (not null or empty)
            _continuationToken = !string.IsNullOrEmpty(resp.ContinuationToken) ? resp.ContinuationToken : null;
            
            Logger.LogDebug("Response: TotalRecords={TotalRecords}, TotalPages={TotalPages}, PageSize={PageSize}", 
                _totalRecords, _totalPages, _pageSize);
            
            Logger.LogDebug("Received response: ContinuationToken={Token}", 
                resp.ContinuationToken ?? "null");

            UpdateTableData(resp.Data);
            _dataChanged = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "LoadData error: {Message}", ex.Message);
        }
        finally
        {
            _isLoading = false;
            _dataChanged = true;
            await InvokeAsync(StateHasChanged).NoSync();
        }
    }

    private async Task HandleManualRequest(CancellationToken cancellationToken = default)
    {
        if (!OnManualRequest.HasDelegate) return;
        
        _isLoading = true;
        _dataChanged = true;
        await InvokeAsync(StateHasChanged).NoSync();
        
        try
        {
            var request = new QuarkTableRequest
            {
                Start = (_currentPage - 1) * _pageSize,
                Length = _pageSize,
                Search = new QuarkTableSearch {Value = _searchTerm},
                Order = _currentOrders,
                ContinuationToken = _continuationToken
            };
            await OnManualRequest.InvokeAsync(request);
            _dataChanged = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "HandleManualRequest error: {Message}", ex.Message);
        }
        finally
        {
            _isLoading = false;
            _dataChanged = true;
            await InvokeAsync(StateHasChanged).NoSync();
        }
    }

    private void UpdateTableData(object? data)
    {
        _columns.Clear();
        _rows.Clear();
        switch (data)
        {
            case List<List<string>> list when list.Count > 0:
                _columns.AddRange(list[0]);
                _rows.AddRange(list.Skip(1));
                break;
            case List<Dictionary<string, object>> dict when dict.Count > 0:
                _columns.AddRange(dict[0].Keys.Select(k => k.ToString()));
                foreach (Dictionary<string, object> row in dict)
                {
                    _rows.Add(_columns.Select(c => row[c]?.ToString() ?? string.Empty).ToList());
                }

                break;
        }
        
        Logger.LogDebug("Updated table data: {ColumnCount} columns, {RowCount} rows", _columns.Count, _rows.Count);
    }

    private string GetSortClass(string col)
    {
        QuarkTableOrder? o = _currentOrders.FirstOrDefault(x => x.Column == col);
        return o?.Direction switch {"asc" => "quark-table-sorted-asc", "desc" => "quark-table-sorted-desc", _ => string.Empty};
    }

    private RenderFragment GetSortIndicator(string col) => builder =>
    {
        QuarkTableOrder? o = _currentOrders.FirstOrDefault(x => x.Column == col);
        builder.AddContent(0, o?.Direction switch {"asc" => " â†‘", "desc" => " â†“", _ => " â†•"});
    };

    private string GetSearchPositionClass()
    {
        switch (Options.SearchPosition)
        {
            case SearchPosition.StartValue: return "search-start";
            case SearchPosition.CenterValue: return "search-center";
            default: return "search-end";
        }
    }

    protected override bool ShouldRender()
    {
        bool s = _dataChanged;
        _dataChanged = false;
        return s;
    }

    public async ValueTask DisposeAsync()
    {
        await _debouncer.DisposeAsync();
    }

}